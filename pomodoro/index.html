<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç•ªèŒ„é’Ÿ pomodoro</title>
    <style>
      :root {
        --tomato: #d32816;
        --btn-bg: var(--tomato);
        --btn-fg: white;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue',
          sans-serif;
      }

      .tomato {
        color: var(--tomato);
      }

      .tc {
        text-align: center;
      }

      .hidden {
        display: none;
      }

      .action {
        margin-top: 4em;
      }

      .action button {
        font-size: 1.5em;
        padding: 1em 2em;
        border-radius: 0.5em;
        font-weight: bold;
        border-width: 0;
        color: var(--btn-fg);
        background: var(--btn-bg);
        cursor: pointer;
      }

      .time {
        font-size: 4em;
      }
    </style>
  </head>
  <body>
    <main class="tc">
      <h1 class="tomato">ğŸ… ç•ªèŒ„é’Ÿ</h1>
      <div id="time" class="time">25:00</div>
      <div class="action">
        <button id="start-btn" type="button">å¼€å§‹è®¡æ—¶</button>
        <button id="quit-btn" class="hidden" type="button">æ”¾å¼ƒè®¡æ—¶</button>
      </div>
    </main>

    <audio
      id="tick"
      loop
      src="https://cdn.pixabay.com/audio/2024/10/02/audio_aaa48ac79b.mp3"
    />
    <audio id="alarm" src="./alarm.mp3" />

    <script>
      // ä¸€ä¸ªç•ªèŒ„é’Ÿè®¡æ—¶è·¨åº¦ä¸º 25 åˆ†é’Ÿ
      const TIME_SPAN = 25 * 60 * 1000
      const TICK = 50

      let _startTime = 0
      let _endTime = _startTime + TIME_SPAN
      let _timer = null

      const startBtnEl = $('#start-btn')
      const quitBtnEl = $('#quit-btn')
      const timeEl = $('#time')
      /** @type {HTMLAudioElement} */
      const tickAudio = $('#tick')
      /** @type {HTMLAudioElement} */
      const alarmAudio = $('#alarm')

      init()

      function init() {
        startBtnEl.addEventListener('click', handleStart)
        quitBtnEl.addEventListener('click', handleQuit)

        resetTime()
      }

      function reset() {
        clearInterval(_timer)

        resetTime()

        toggleVisible(startBtnEl, true)
        toggleVisible(quitBtnEl, false)

        tickAudio.pause()
        alarmAudio.pause()
      }

      function resetTime() {
        _startTime = Date.now()
        _endTime = _startTime + TIME_SPAN
        renderTime(_startTime)
      }

      /**
       * æ›´æ–°å€’è®¡æ—¶çš„æ˜¾ç¤ºæ–‡æœ¬
       * @param {number} t
       */
      function renderTime(t) {
        timeEl.textContent = getRenderTime(t, _endTime)
      }

      /**
       * è·å–æ˜¾ç¤ºçš„æ—¶é—´æ–‡æœ¬
       * @param {number} start
       * @param {number} end
       */
      function getRenderTime(start, end) {
        const diff = end - start
        const diffInSec = Math.floor(diff / 1000)

        const m = Math.floor(diffInSec / 60)
        const s = diffInSec % 60

        return [m, s].map(n => String(n).padStart(2, '0')).join(':')
      }

      function handleStart() {
        resetTime()

        startTimer()

        toggleVisible(startBtnEl, false)
        toggleVisible(quitBtnEl, true)
      }

      function handleQuit() {
        const result = confirm('ç¡®å®šè¦æ”¾å¼ƒå½“å‰ç•ªèŒ„é’Ÿå—ï¼Ÿ')
        if (result) {
          reset()
        }
      }

      /**
       * å¯åŠ¨è®¡æ—¶å™¨
       */
      function startTimer() {
        if (_timer) clearInterval(_timer)

        console.log('startTimer')

        tickAudio.play()

        _timer = setInterval(() => {
          const now = Date.now()
          if (now >= _endTime) {
            clearInterval(_timer)

            tickAudio.pause()
            alarmAudio.currentTime = 0
            alarmAudio.play()

            toggleVisible(quitBtnEl, false)

            setTimeout(() => {
              reset()
            }, 5000)
            return
          }

          renderTime(now)
        }, TICK)
      }

      function toggleVisible(el, visible) {
        if (visible) {
          el.classList.remove('hidden')
        } else {
          el.classList.add('hidden')
        }
      }

      function $(el) {
        return document.querySelector(el)
      }
    </script>
  </body>
</html>
